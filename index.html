<!DOCTYPE html>
<html>

<head>
    <title>Discrete mathematics project</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/uikit.min.css" />
    <script src="js/uikit.min.js"></script>
    <script src="js/uikit-icons.min.js"></script>
</head>

<body>
    <div class="uk-navbar-container tm-navbar-container uk-sticky uk-sticky-fixed uk-active uk-sticky-below">
        <div class="uk-container uk-container-expand">
            <nav class="uk-navbar">
                <div class="uk-navbar-left">
                    FstRT
                </div>
            </nav>
        </div>
    </div>
    <div>
        <ul class="uk-tab-bottom uk-child-width-expand" uk-tab>
            <li><a href="#">–ü–æ–∏—Å–∫ –º–∞—Ä—à—Ä—É—Ç–∞</a></li>
            <li><a href="#">–ö–∞—Ä—Ç–∞</a></li>
            <li><a href="#">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a></li>
        </ul>

        <ul class="uk-switcher uk-margin">
            <div id="router-tab" class="uk-container">
                <div class="uk-padding">
                    <h1 class="uk-text-lead">–í—ã–±–æ—Ä –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1>
                    <div>
                        <div class="uk-child-width-expand" uk-grid>
                            <div>
                                <label for="start_station">–¢–æ—á–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏</label>
                                <select id="start_station" name="start_station" class="uk-select">
                                    <option value="-1">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>
                                </select>
                            </div>
                            <div>
                                <label for="end_station">–¢–æ—á–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</label>
                                <select id="end_station" name="end_station" class="uk-select">
                                    <option value="-1">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>
                                </select>
                            </div>
                            <div>
                                <button class="uk-button uk-button-primary uk-width-1-1 uk-height-1-1" onclick="doRouteSearch(this)">–ù–∞–π—Ç–∏</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="uk-padding">
                    <h1 class="uk-text-lead">–†–µ–∑—É–ª—å—Ç–∞—Ç</h1>
                    <div>
                        <p class="uk-text-meta">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏ –ø—Ä–∏–±—ã—Ç–∏—è, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –º–∞—Ä—à—Ä—É—Ç</p>
                        <div class="uk-grid-match uk-child-width-1-2" uk-grid>
                            <div>
                                <p id="report_first"></p>
                            </div>
                            <div>
                                <p id="report_second"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div>
                <div class="uk-section-secondary" id="devsp_map" hidden>
                    <button onclick="clear_graph()" class="uk-button-small uk-button-default">Clear graph</button>
                    <button onclick="create_node()" class="uk-button-small uk-button-default">Create new node</button>
                    <button onclick="remove_node()" class="uk-button-small uk-button-default">Remove node</button>
                    <button onclick="create_route()" class="uk-button-small uk-button-default">Manages routes</button>
                    <button onclick="serialize_graph()" class="uk-button-small uk-button-default">Serialize graph to clipboard</button>
                    <button onclick="deserialize_graph()" class="uk-button-small uk-button-default">Deserialize graph from clipboard</button>
                </div>
                <div id="map-tab">
                </div>
            </div>
            
            <div id="settings-tab">
                <div class="uk-section-default uk-padding uk-grid-large uk-child-width-expand@s uk-text-center" uk-grid>
                    <div class="uk-grid-1-2">
                        <h1 class="uk-text-lead">–°—Ç–æ–∏–º–æ—Å—Ç—å –ø—É—Ç–∏</h1>
                        <div class="uk-margin uk-grid-small" uk-grid>
                            <input class="uk-input uk-width-3-4" type="text" placeholder="–°—Ç–æ–∏–º–æ—Å—Ç—å –ø—É—Ç–∏">
                            <button onclick="changePrice(this)" class="uk-button uk-button-default uk-input uk-width-1-4">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                        </div>
                    </div>
                    
                    <div class="uk-grid-1-2">
                        <h1 class="uk-text-lead">–í—ã–±—Ä–∞—Ç—å –≥–æ—Ä–æ–¥</h1>
                        <div class="uk-margin uk-grid-small" uk-grid>
                            <select class="uk-select" onchange="if (typeof(this.selectedIndex) !== typeof(undefined)) { clear_graph(); loadData(this.value); }">
                                <option value="gways">‚úî –ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫. –°–ª—É—á–∞–π–Ω—ã–π 1. 20 –≤–µ—Ä—à–∏–Ω.</option>
                                <option value="bhdsd">‚ô®‚ô® –ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫. –°–ª—É—á–∞–π–Ω—ã–π 2. 30 –≤–µ—Ä—à–∏–Ω.</option>
                                <option value="nu8we">üí¢üí¢ –ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫. –°–ª—É—á–∞–π–Ω—ã–π 3. 40 –≤–µ—Ä—à–∏–Ω.</option>
                                <option value="iemcl">üí¢üí¢üí¢ –ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫. –°–ª—É—á–∞–π–Ω—ã–π 4. 100 –≤–µ—Ä—à–∏–Ω.</option>
                                <option value="prep_1">üëç‚úî –°–ª—É—á–∞–π–Ω—ã–µ –≤–µ—Ä—à–∏–Ω—ã. –ü—Ä–µ–¥–ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã–π.</option>
                                <option value="real_data">üí¢üí¢üí¢üí¢ –ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫. –†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</option>
                                <option value="real_data_small">üí¢üí¢ –ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫. –†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –ú–∞–ª—ã–π –Ω–∞–±–æ—Ä.</option>
                                <option value="semi_real_data">üëçüî•‚úî –ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫. –ß–∞—Å—Ç–∏—á–Ω–æ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –ú–∞–ª—ã–π –Ω–∞–±–æ—Ä.</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="uk-section-secondary uk-padding">
                    <h1 class="uk-text-lead">Developers area</h1>
                    <p uk-margin>
                        <label><input class="uk-checkbox" type="checkbox" id="debug_checker"> Enable DEBUG</label>
                        <br>
                        <button onclick="clear_graph()" class="uk-button uk-button-default">Clear graph</button>
                        <button onclick="create_node()" class="uk-button uk-button-default">Create new node</button>
                        <button onclick="remove_node()" class="uk-button uk-button-default">Remove node</button>
                        <br>
                        <button onclick="create_route()" class="uk-button uk-button-default">Manages routes</button>
                        <br>
                        <button onclick="serialize_graph()" class="uk-button uk-button-default">Serialize graph to clipboard</button>
                        <button onclick="deserialize_graph()" class="uk-button uk-button-default">Deserialize graph from clipboard</button>
                    </p>
                </div>
            </div>
        </ul>
    </div>
</body>

<dialog id="create_node_dialog">
    <form onsubmit="return false;">
        <section>
            <p>
                <label for="in_node_name">Node name</label>
                <input type="text" id="in_node_name" name="in_node_name" placeholder="Node 1" class="uk-input">
            </p>
            <p>
                <label for="in_node_position">Node position</label>
                <input type="text" id="in_node_position" name="in_node_position" placeholder="255 -30" class="uk-input">
            </p>
        </section>
        <menu>
            <button id="create_node_dialog_cancel" type="reset" class="uk-button uk-button-secondary">Cancel</button>
            <button id="create_node_dialog_confirm" class="uk-button uk-button-primary">Confirm</button>
        </menu>
    </form>
</dialog>

<dialog id="remove_node_dialog">
    <form onsubmit="return false;">
        <section>
            <p>
                <label for="node_id">Node name</label>
                <select id="node_id" name="node_id" class="uk-select">
                    <option value="-1">Not selected</option>
                </select>
            </p>
        </section>
        <menu>
            <button id="remove_node_dialog_cancel" type="reset" class="uk-button uk-button-secondary">Cancel</button>
            <button id="remove_node_dialog_confirm" class="uk-button uk-button-danger">Remove</button>
        </menu>
    </form>
</dialog>

<dialog id="manage_connections_dialog">
    <form onsubmit="return false;">
        <section>
            <p>
                <label for="node1_id">Start node id</label>
                <select id="node1_id" name="node1_id" class="uk-select">
                    <option value="-1">Not selected</option>
                </select>
            </p>
            <p>
                <label for="node2_id">End node id</label>
                <select id="node2_id" name="node2_id" class="uk-select">
                    <option value="-1">Not selected</option>
                </select>
            </p>
            <p>
                <label for="route_length">Route length (if creating new)</label>
                <input type="text" id="route_length" name="route_length" placeholder="255 /* &gt; 0 */" class="uk-input">
            </p>
        </section>
        <menu>
            <button id="manage_connections_dialog_cancel" type="reset" class="uk-button uk-button-secondary">Cancel</button>
            <button id="remove_node_connection" class="uk-button uk-button-danger">Delete</button>
            <button id="create_node_connection" class="uk-button uk-button-primary">Create</button>
        </menu>
    </form>
</dialog>

<script>
let start_station_selector = null;
let end_station_selector = null;
let report_first_el = null;
let report_second_el = null;

let changePrice = function(callee) {
    let nval = ~~(callee.previousElementSibling.value)
    if (nval > 0) {
        router.basePrice = nval;
        callee.previousElementSibling.value = "";
    }
    else {
        alert(`–ó–Ω–∞—á–µ–Ω–∏–µ "${callee.previousElementSibling.value}" –Ω–µ–ª—å–∑—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Ü–µ–Ω—ã (–Ω–µ —á–∏—Å–ª–æ, –ª–∏–±–æ –º–µ–Ω—å—à–æ –Ω—É–ª—è)`);
    }
}

let routeToMessage = function(route) {
    let ft = route.shift();
    let lt = route.pop();

    let msg = `–ù–∞—á–Ω–∏—Ç–µ —Å–≤–æ–π –ø—É—Ç—å —Å <b>${ft.title}</b>, `; 
    if (route.length > 0) {
         msg += `–∑–∞—Ç–µ–º –¥–≤–∏–≥–∞–π—Ç–µ—Å—å –∫ ${route.map(bs => `<b>${bs.title}</b>`).join(", –∑–∞—Ç–µ–º –∫ ")}, `;
    }
    msg += `–æ—Ç—Ç—É–¥–∞ –≤—ã –¥–æ–µ–¥–µ—Ç–µ –¥–æ <b>${lt.title}</b>`;

    return msg;
}

let doRouteSearch = function(callee) {
    report_first_el.innerHTML = "";
    report_second_el.innerHTML = "";
    clearSelectorData();

    report_first_el.textContent = "–ò—â–µ–º...";
    let [sf, ss] = Array.from(callee.closest("[uk-grid]").querySelectorAll("select")).map(el => ~~el.value);

    if (sf === -1 || ss === -1) {
        report_first_el.textContent = "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—á–∞–ª—å–Ω—É—é –∏ –∫–æ–Ω–µ—á–Ω—É—é —Ç–æ—á–∫–∏.";
    }
    else if (sf === ss) {
        report_first_el.innerHTML = "–í—ã–±–∏—Ä–∞—Ç—å –Ω–∞—á–∞–ª—å–Ω–æ–π –∏ –∫–æ–Ω–µ—á–Ω–æ–π —Ç–æ—á–∫–æ–π –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ –º–µ—Å—Ç–æ –Ω–µ –∏–º–µ–µ—Ç —Å–º—ã—Å–ª–∞.<br>";
        report_first_el.innerHTML += "–ë—ã—Ç—å –º–æ–∂–µ—Ç, –≤—ã –æ—à–∏–±–ª–∏—Å—å –≤ —Å–≤–æ—ë–º –≤—ã–±–æ—Ä–µ?";
    }
    else {
        let [sp, ep] = [router.getNodeById(sf), router.getNodeById(ss)];
        console.log([sf, ss, sp, ep]);

        selected_nodes.first = sp;
        selected_nodes.second = ep;
        
        let [fRoute, cRoute] = [[], []];

        try {
            fRoute = router.findFastestRoute(sp, ep);
            cRoute = router.findCheapestRoute(sp, ep);
        }
        catch (e) {
            report_first_el.textContent = "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –º—ã –Ω–µ –Ω–∞—à–ª–∏ –º–∞—Ä—à—Ä—É—Ç–∞ :(";
            return;
        }
        
        if (fRoute.length === 0 && fRoute.length === cRoute.length) {
            report_first_el.textContent = "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –º—ã –Ω–µ –Ω–∞—à–ª–∏ –º–∞—Ä—à—Ä—É—Ç–∞ :(";
            return;
        }

        let fData = router.calcFullRouteStats(fRoute);
        let cData = router.calcFullRouteStats(cRoute);

        let uRoute = fData.time === cData.time && fData.money === cData.money;

        if (uRoute) {
            report_first_el.innerHTML = "–°–∏—Å—Ç–µ–º–∞ –Ω–∞—à–ª–∞ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø—É—Ç—å:<br>";
            report_first_el.innerHTML += `–í—ã –ø–æ—Ç—Ä–∞—Ç–∏—Ç–µ ${fData.money} —É.–µ., –∞ –ø–µ—Ä–µ–¥–≤–∏–∂–µ–Ω–∏–µ –∑–∞–π–º—ë—Ç ${~~(fData.time)} –µ.–≤.<br>`;
            report_first_el.innerHTML += routeToMessage(fRoute);
        }
        else {
            if (fRoute.length > 0) {
                report_first_el.innerHTML = "–°–∏—Å—Ç–µ–º–∞ –Ω–∞—à–ª–∞ —Å–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π –ø—É—Ç—å:<br>";
                report_first_el.innerHTML += `–í—ã –ø–æ—Ç—Ä–∞—Ç–∏—Ç–µ ${fData.money} —É.–µ., –∞ –ø–µ—Ä–µ–¥–≤–∏–∂–µ–Ω–∏–µ –∑–∞–π–º—ë—Ç ${~~(fData.time)} –µ.–≤.<br>`;
                report_first_el.innerHTML += routeToMessage(fRoute);
            }
            
            if (cRoute.length > 0) {
                report_second_el.innerHTML = "–°–∏—Å—Ç–µ–º–∞ –Ω–∞—à–ª–∞ —Å–∞–º—ã–π –¥–µ—à—ë–≤—ã–π –ø—É—Ç—å:<br>";
                report_second_el.innerHTML += `–í—ã –ø–æ—Ç—Ä–∞—Ç–∏—Ç–µ ${cData.money} —É.–µ., –∞ –ø–µ—Ä–µ–¥–≤–∏–∂–µ–Ω–∏–µ –∑–∞–π–º—ë—Ç ${~~(cData.time)} –µ.–≤.<br>`;
                report_second_el.innerHTML += routeToMessage(cRoute);
            }
        }
    }
};

let redrawSelectors = function() {
    report_first_el.innerHTML = "";
    report_second_el.innerHTML = "";

    removeOptions(start_station_selector);
    removeOptions(end_station_selector);

    {
        let option = document.createElement("option");
        option.value = "-1";
        option.textContent = "–ù–µ –≤—ã–±—Ä–∞–Ω–æ";

        start_station_selector.add(option.cloneNode(true));
        end_station_selector.add(option.cloneNode(true));
    }

    for (let node of router.nodes) {
        let option = document.createElement("option");
        option.value = node.id;
        option.textContent = node.title;

        start_station_selector.add(option.cloneNode(true));
        end_station_selector.add(option.cloneNode(true));
    }
}

document.addEventListener("DOMContentLoaded", () => {
    start_station_selector = document.getElementById("start_station");
    end_station_selector = document.getElementById("end_station");
    report_first_el = document.getElementById("report_first");
    report_second_el = document.getElementById("report_second");
    
    document.getElementById("debug_checker").addEventListener("change", function() { 
        DEBUG = this.checked;
        document.getElementById("devsp_map").toggleAttribute("hidden", !DEBUG);
    });

    router.addListeners(redrawSelectors, redrawSelectors);    

    redrawSelectors();
});
</script>

<script src="system/p5.min.js"></script>
<script src="system/node.js"></script>
<script src="system/router.js"></script>

<script src="system/preloaded_map_data.js"></script>
<script src="system/app.js"></script>

</html>
